<mat-card>
  <mat-card-header>
    <mat-card-title>Transferencias entre Almacenes</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="transferenciaForm" (ngSubmit)="$event.preventDefault()">
      <div class="form-grid">
        <!-- Almacén Origen -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Almacén Origen</mat-label>
          <mat-select formControlName="almacenOrigenId">
            <mat-option *ngFor="let almacen of almacenes" [value]="almacen.id">
              {{ almacen.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="almacenOrigenInvalid">
            Debe seleccionar un almacén de origen
          </mat-error>
        </mat-form-field>

        <!-- Almacén Destino -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Almacén Destino</mat-label>
          <mat-select formControlName="almacenDestinoId">
            <mat-option *ngFor="let almacen of almacenes" [value]="almacen.id">
              {{ almacen.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="almacenDestinoInvalid">
            Debe seleccionar un almacén de destino
          </mat-error>
        </mat-form-field>

        <!-- Producto -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Producto</mat-label>
          <mat-select formControlName="productoId" [disabled]="!transferenciaForm.get('almacenOrigenId')?.value">
            <mat-option *ngFor="let producto of productos" [value]="producto.productoId">
              {{ producto.productoNombre }} ({{ producto.productoCodigo }}) - Disponible: {{ producto.cantidadDisponible }}kg
            </mat-option>
          </mat-select>
          <mat-error *ngIf="productoInvalid">
            Debe seleccionar un producto
          </mat-error>
          <mat-hint *ngIf="loadingProductos">Cargando productos...</mat-hint>
        </mat-form-field>

        <!-- Lote Disponible -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Lote Disponible</mat-label>
          <mat-select formControlName="loteId" [disabled]="!transferenciaForm.get('productoId')?.value">
            <mat-option *ngFor="let lote of lotes" [value]="lote.loteId">
              {{ getLoteLabel(lote) }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="loteInvalid">
            Debe seleccionar un lote
          </mat-error>
          <mat-hint *ngIf="loadingLotes">Cargando lotes...</mat-hint>
        </mat-form-field>

        <!-- Cantidad -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Cantidad (kg)</mat-label>
          <input 
            matInput 
            type="number" 
            formControlName="cantidad" 
            min="0.01" 
            step="0.01"
            placeholder="0.00">
          <mat-error *ngIf="cantidadInvalid">
            La cantidad debe ser mayor a 0
          </mat-error>
        </mat-form-field>

        <!-- Motivo -->
        <mat-form-field appearance="outline" class="w-100 motivo-field">
          <mat-label>Motivo (opcional)</mat-label>
          <input matInput formControlName="motivo" placeholder="Motivo de la transferencia">
        </mat-form-field>
      </div>

      <div class="button-row">
        <button 
          mat-raised-button 
          color="primary" 
          type="button"
          (click)="agregarTransferencia()"
          [disabled]="transferenciaForm.invalid || submitting">
          <mat-icon>add</mat-icon>
          {{ submitting ? 'Procesando...' : 'Agregar Transferencia' }}
        </button>
      </div>
    </form>

    <!-- Tabla de transferencias realizadas -->
    <div class="transfers-table-container" *ngIf="transferenciasRealizadas.length > 0">
      <h3>Transferencias Realizadas</h3>
      <table mat-table [dataSource]="transferenciasRealizadas" class="mat-elevation-z2">
        
        <!-- Columna Producto -->
        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let item">{{ item.producto }}</td>
        </ng-container>

        <!-- Columna Lote -->
        <ng-container matColumnDef="lote">
          <th mat-header-cell *matHeaderCellDef>Lote</th>
          <td mat-cell *matCellDef="let item">{{ item.lote }}</td>
        </ng-container>

        <!-- Columna Cantidad -->
        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef>Cantidad</th>
          <td mat-cell *matCellDef="let item">{{ item.cantidad }} kg</td>
        </ng-container>

        <!-- Columna Origen -->
        <ng-container matColumnDef="origen">
          <th mat-header-cell *matHeaderCellDef>Origen</th>
          <td mat-cell *matCellDef="let item">{{ item.origen }}</td>
        </ng-container>

        <!-- Columna Destino -->
        <ng-container matColumnDef="destino">
          <th mat-header-cell *matHeaderCellDef>Destino</th>
          <td mat-cell *matCellDef="let item">{{ item.destino }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </mat-card-content>
</mat-card>
